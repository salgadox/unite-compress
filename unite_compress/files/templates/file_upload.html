{% extends 'base.html' %}
{% block title %}File Upload{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
    <div>
	<h1>File upload</h1>
	<div>Select file to upload:</div>
	<input id="input" type="file" />
	<button id="submit-button" class="btn btn-primary" type="button">Upload</button>
	<div id="message"></div>
    </div>

{% endblock %}

{% block inline_javascript %}
    <script>
	 var fileInput = $('#input');
	 var message = $('#message');
	 var submitButton = $('#submit-button');

	 submitButton.on('click', function() {
		 var file = fileInput[0].files[0];

		 if (file) {
		     var fileName = file.name;
		     var fileType = file.type;

		     $.ajax({
			 url: "{% url 'api:file-upload:upload:direct:start' %}",
			 method: "POST",
			 data: { file_name: fileName, file_type: fileType },
			 success: function(response) {
			     // var data = response.data;
			     var postData = new FormData();
				 var fields = response.fields;
				 for (var key in fields){
					postData.append(key, fields[key]);
				 }
			     postData.append('file', file);
				 message.html('File is uploading');
			     $.ajax({
				 url: response.url,
				 method: 'POST',
				 data: postData,
				 processData: false,
				 contentType: false,
				 success: function() {
				     $.ajax({
					 url: "{% url 'api:file-upload:upload:direct:finish' %}",
					 method: 'POST',
					 data: { file_id: response.id },
					 success: function() {
					     message.html('File upload completed!');
						 window.location.href="{% url 'files:latest-file' %}";
					 },
					 error: function() {
					     message.html('File upload failed!');
					 }
				     });
				 },
				 error: function() {
				     message.html('File upload failed!');
				 }
			     });
			 },
			 error: function() {
			     message.html('File upload failed!');
			 }
		     });
		 }
	     });
    </script>
{% endblock %}
